<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compteurs synchronisÃ©s â€“ Flophilclo</title>
  <style>
    :root { --bg:#0b0f14; --card:#121821; --txt:#e6e6e6; --muted:#9aa4b2; --gold:#f0b64b; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Arial; color:var(--txt); min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(255,215,128,.10), transparent 60%),
        radial-gradient(900px 700px at 110% 30%, rgba(120,180,255,.10), transparent 60%),
        radial-gradient(900px 700px at -10% 70%, rgba(160,255,190,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 120%, rgba(220,180,120,.10), transparent 60%),
        var(--bg);
    }
    .wrap{width:min(96vw,760px); padding:18px}
    .card{background:var(--card); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); position:relative; overflow:hidden}

    h1{
      margin:0 0 10px; font-size:1.25rem;
      background: linear-gradient(90deg,#ffd27a,#ffe8b3,#ffd27a);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input,button,select{font-size:1rem; padding:10px 12px; border-radius:12px; border:1px solid #263041; background:#0f141b; color:var(--txt)}
    input{min-width:190px}
    button{cursor:pointer; border:0; background:#202938}
    button.primary{background:var(--gold); color:#1a1307; font-weight:700}
    .muted{color:var(--muted); font-size:.9rem}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px}

    /* Panneaux + liserÃ© dorÃ© */
    .panel{
      background:#0f141b; border:1px solid #3a2a10; border-radius:14px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,215,128,.12);
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    .panel:hover{ border-color:#6a531e; box-shadow:0 12px 34px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,215,128,.18); }
    .panel h2{margin:0 0 6px; font-size:1.05rem}
    .value{font-size:2.8rem; font-weight:700; margin:8px 0 12px; text-align:center}
    .btns{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .ok{color:#9cff9c}
    .err{color:#ff9c9c}
    .code{font-family:monospace; background:#0e1826; padding:6px 10px; border-radius:8px; border:1px dashed #2b3c54}

    /* Logo */
    .branding{
      position:absolute; top:10px; left:10px; display:flex; align-items:center; gap:10px;
      z-index:2; padding:6px 10px; border-radius:12px; background:rgba(0,0,0,.25); backdrop-filter: blur(4px);
    }
    .branding img{height:32px; width:auto; display:block}
    .branding .mark{font-weight:800; letter-spacing:.3px; color:#ffd27a}

    /* IMAGE TOURNANTE */
    .wheel-wrap{
      position:absolute; top:10px; right:10px; z-index:2;
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
    }
    .wheel-controls{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .wheel-img{
      width:110px; height:110px; border-radius:50%;
      overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      animation: spin 180s linear infinite;  /* 180 s par tour, sens horaire */
      background:#0d1420;
    }
    .wheel-img.pause{ animation-play-state: paused; }
    .wheel-img img{ width:100%; height:100%; object-fit:cover; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* DÃ© */
    .diceBox{margin-top:16px; text-align:center}
    .diceFace{
      display:inline-flex; align-items:center; justify-content:center;
      width:68px; height:68px; margin-top:8px;
      border-radius:12px; border:1px solid #2a3446; background:#0e1622;
      font-size:2rem; font-weight:800; box-shadow: inset 0 0 10px rgba(0,0,0,.35);
    }

    /* Footer */
    .foot{
      position:absolute; left:14px; bottom:10px; color:#ccb06a; font-size:.85rem; opacity:.9;
      text-shadow:0 1px 0 rgba(0,0,0,.4);
    }

    @media (max-width:560px){
      .wheel-img{width:86px; height:86px}
      .branding{transform: scale(.95); transform-origin: top left}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- LOGO -->
      <div class="branding" title="Flophilclo">
        <img src="logo-flophilclo.png" alt="Logo Flophilclo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'">
        <span class="mark" style="display:none">Flophilclo</span>
      </div>

      <!-- IMAGE DES 4 Ã‰LÃ‰MENTS QUI TOURNE -->
      <div class="wheel-wrap">
        <div class="wheel-controls">
          <button id="toggleWheel">Masquer lâ€™image</button>
          <button id="pausePlay">Pause</button>
          <select id="speedSel" title="Vitesse">
            <option value="180">180 s / tour</option>
            <option value="120">120 s / tour</option>
            <option value="60">60 s / tour</option>
            <option value="30">30 s / tour</option>
          </select>
        </div>
        <div id="wheel" class="wheel-img" aria-label="Ã‰lÃ©ments Flophilclo">
          <img src="elements.png" alt="Image des Ã©lÃ©ments" />
        </div>
      </div>

      <h1>Compteurs synchronisÃ©s â€“ Flophilclo</h1>
      <div class="muted" id="status">PrÃªt â€“ crÃ©e une salle ou rejoins-en une.</div>

      <!-- Connexion salle -->
      <div class="row" style="margin-top:10px;">
        <button id="create" class="primary">CrÃ©er une salle</button>
        <input id="code" placeholder="Code salle (ex: 4M7QK9)" />
        <button id="join">Rejoindre</button>
        <select id="role" title="Votre rÃ´le">
          <option value="J1">Je suis J1</option>
          <option value="J2">Je suis J2</option>
        </select>
      </div>

      <div class="muted" style="margin-top:8px;">
        Code salle : <span id="roomCode" class="code">â€”</span>
        &nbsp;â€¢&nbsp; DerniÃ¨re MAJ : <span id="last">â€”</span>
      </div>

      <!-- Deux compteurs -->
      <div class="grid">
        <div class="panel">
          <h2>Joueur 1</h2>
          <div id="v1" class="value">0000</div>
          <div class="btns">
            <button data-act="J1:-5">â€“5</button>
            <button data-act="J1:-1">â€“1</button>
            <button class="primary" data-act="J1:+1">+1</button>
            <button data-act="J1:+5">+5</button>
            <button data-act="J1:reset">Reset</button>
          </div>
        </div>
        <div class="panel">
          <h2>Joueur 2</h2>
          <div id="v2" class="value">0000</div>
          <div class="btns">
            <button data-act="J2:-5">â€“5</button>
            <button data-act="J2:-1">â€“1</button>
            <button class="primary" data-act="J2:+1">+1</button>
            <button data-act="J2:+5">+5</button>
            <button data-act="J2:reset">Reset</button>
          </div>

          <!-- DÃ© animÃ© -->
          <div class="diceBox">
            <button id="roll" class="primary">ðŸŽ² Lancer le dÃ©</button>
            <div id="die" class="diceFace">â€”</div>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        Astuce : un tÃ©lÃ©phone **crÃ©e** la salle (bouton dorÃ©), lâ€™autre **entre le code** puis Â« Rejoindre Â».  
        Seul J1 peut modifier J1, et seul J2 peut modifier J2.
      </div>

      <!-- Copyright -->
      <div class="foot">Â© 2025 Flophilclo</div>
    </div>
  </div>

  <!-- Firebase via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDB534z5JxxP8Sa29wQ9QjjOsHgK1Tfo1k",
      authDomain: "flophilclo-compteur.firebaseapp.com",
      projectId: "flophilclo-compteur",
      storageBucket: "flophilclo-compteur.appspot.com",
      messagingSenderId: "399568726801",
      appId: "1:399568726801:web:22589d036e369258323ab0"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI refs
    const $status = document.getElementById("status");
    const $roomCode = document.getElementById("roomCode");
    const $last = document.getElementById("last");
    const $v1 = document.getElementById("v1");
    const $v2 = document.getElementById("v2");
    const $code = document.getElementById("code");
    const $role = document.getElementById("role");
    const $create = document.getElementById("create");
    const $join = document.getElementById("join");

    // Image tournante controls
    const wheel = document.getElementById("wheel");
    const toggleWheelBtn = document.getElementById("toggleWheel");
    const pausePlayBtn = document.getElementById("pausePlay");
    const speedSel = document.getElementById("speedSel");

    let roomRef = null;
    let unsub = null;

    const fmt4 = (n)=> String(n ?? 0).padStart(4,"0");

    function randCode(len=6){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return Array.from({length:len},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    async function createRoom(){
      const code = randCode(6);
      roomRef = doc(db, "rooms", code);
      await setDoc(roomRef, { code, j1:0, j2:0, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
      $roomCode.textContent = code;
      $code.value = code;
      listenRoom();
    }

    async function joinRoom(code){
      if(!code) return;
      roomRef = doc(db, "rooms", code.toUpperCase());
      const snap = await getDoc(roomRef);
      if(!snap.exists()){
        await setDoc(roomRef, { code:code.toUpperCase(), j1:0, j2:0, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
      }
      $roomCode.textContent = code.toUpperCase();
      listenRoom();
    }

    function listenRoom(){
      if (unsub) unsub();
      unsub = onSnapshot(roomRef, (snap)=>{
        if(!snap.exists()) return;
        const d = snap.data();
        $v1.textContent = fmt4(d.j1 || 0);
        $v2.textContent = fmt4(d.j2 || 0);
        $last.textContent = d.updatedAt?.toDate?.().toLocaleTimeString?.() ?? "â€”";
        $status.textContent = "ConnectÃ© Ã  la salle Â« "+d.code+" Â»";
        $status.className = "ok";
      }, (err)=>{
        $status.textContent = "Erreur Ã©coute : "+err.message;
        $status.className = "err";
      });
    }

    async function applyAction(target, action){
      if(!roomRef){ alert("CrÃ©e ou rejoins une salle d'abord."); return; }
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(roomRef);
        let j1 = 0, j2 = 0;
        if (snap.exists()){ j1 = Number(snap.data().j1||0); j2 = Number(snap.data().j2||0); }

        const apply = (current, op)=>{
          if (op === "reset") return 0;
          const n = parseInt(op,10);
          if (isNaN(n)) return current;
          return Math.max(0, current + n);
        };

        if (target==="J1") j1 = apply(j1, action);
        if (target==="J2") j2 = apply(j2, action);

        tx.set(roomRef, { j1, j2, updatedAt: serverTimestamp() }, { merge:true });
      });
    }

    document.querySelectorAll("[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const [who, op] = btn.dataset.act.split(":");
        const myRole = $role.value;
        if (who !== myRole) {
          alert("Seul "+who+" peut modifier ce compteur. Change ton rÃ´le si besoin.");
          return;
        }
        applyAction(who, op);
      });
    });

    $create.addEventListener("click", createRoom);
    $join.addEventListener("click", ()=> joinRoom($code.value.trim()));

    // ContrÃ´les image tournante
    toggleWheelBtn.addEventListener("click", ()=>{
      const visible = wheel.style.display !== "none";
      wheel.style.display = visible ? "none" : "block";
      toggleWheelBtn.textContent = visible ? "Afficher lâ€™image" : "Masquer lâ€™image";
    });
    pausePlayBtn.addEventListener("click", ()=>{
      const paused = wheel.classList.toggle("pause");
      pausePlayBtn.textContent = paused ? "Lecture" : "Pause";
    });
    speedSel.addEventListener("change", ()=>{
      const s = parseInt(speedSel.value,10) || 180;
      wheel.style.animationDuration = s + "s";
    });

    // DÃ© animÃ©
    const rollBtn = document.getElementById("roll");
    const dieOut = document.getElementById("die");
    if (rollBtn && dieOut){
      rollBtn.addEventListener("click", ()=>{
        let t=0; const anim = setInterval(()=>{ dieOut.textContent = (1+Math.floor(Math.random()*6)); if(++t>10){clearInterval(anim)} }, 60);
        setTimeout(()=> dieOut.textContent = (1+Math.floor(Math.random()*6)), 700);
      });
    }
  </script>
</body>
</html>
